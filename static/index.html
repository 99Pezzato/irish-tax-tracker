<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IE Irish Tax Meter (Demo)</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <h1>ðŸ‡®ðŸ‡ª Irish Tax Meter (Demo)</h1>
  <p>Almost real-time estimate based on monthly figures. Swap the sample data for the official Exchequer returns.</p>

  <div id="main">
    <h2 id="total">â‚¬0.00</h2>
    <p id="error" style="color:#ff7777"></p>

    <div class="stats">
      <div>
        <label>Average rate (â‚¬ per second)</label>
        <span id="avg_rate">â€”</span>
      </div>
      <div>
        <label>Anchor YTD (euros)</label>
        <span id="ytd">â€”</span>
      </div>
    </div>

    <div>
      <label>Estimation method</label>
      <span class="method">rolling_3m</span>
    </div>
  </div>

  <p class="formula">
    Formula: <em>Tax(t) = YTD(tâ‚€) + r Ã— (t âˆ’ tâ‚€)</em>, where r is the average rate per second for the latest period.
  </p>

<script>
const fmt = new Intl.NumberFormat('en-IE', {
  style: 'currency',
  currency: 'EUR',
  maximumFractionDigits: 2
});
const fmt2 = new Intl.NumberFormat('en-IE', {
  maximumFractionDigits: 6
});

async function start() {
  try {
    const res = await fetch('/api/state');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const state = await res.json();

    // Match backend JSON structure exactly
    const ytd = parseFloat(state.ytd) || 0;
    const rate = parseFloat(state.avg_rate) || 0;
    const t0 = new Date(state.timestamp).getTime();

    // Initial UI update
    document.getElementById('ytd').textContent = fmt.format(ytd);
    document.getElementById('avg_rate').textContent = fmt2.format(rate) + " â‚¬/s";

    // Start live counter
    function tick() {
      const now = Date.now();
      const elapsed = (now - t0) / 1000.0; // seconds
      const value = ytd + rate * elapsed;
      document.getElementById('total').textContent = fmt.format(value);
      document.getElementById('status').textContent =
        "Updated: " + new Date().toLocaleString('en-IE');
      requestAnimationFrame(tick);
    }

    tick();

  } catch (err) {
    console.error("Fetch error:", err);
    document.getElementById('status').textContent =
      "Error fetching data: " + err.message;
  }
}

start();
</script>
</body>
</html>